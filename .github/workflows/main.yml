name: Ubuntu-GNOME-RDP-FTP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Instalar GNOME y RDP
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y ubuntu-desktop-minimal xrdp dbus-x11
          # Configurar sesión GNOME para RDP
          echo "export GNOME_SHELL_SESSION_MODE=ubuntu" > ~/.xsessionrc
          echo "export XDG_CURRENT_DESKTOP=Ubuntu:GNOME" >> ~/.xsessionrc
          echo "export XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg" >> ~/.xsessionrc
          echo "exec /usr/bin/gnome-session" >> ~/.xsessionrc
          sudo adduser xrdp ssl-cert
          sudo systemctl restart xrdp

      - name: Instalar y Configurar Servidor FTP
        run: |
          sudo apt install -y vsftpd
          # Crear backup de la config original
          sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.bak
          
          # Configuración optimizada para permitir escritura y modo pasivo
          sudo bash -c 'cat > /etc/vsftpd.conf <<EOF
          listen=YES
          listen_ipv6=NO
          anonymous_enable=NO
          local_enable=YES
          write_enable=YES
          local_umask=022
          dirmessage_enable=YES
          use_localtime=YES
          xferlog_enable=YES
          connect_from_port_20=YES
          chroot_local_user=NO
          secure_chroot_dir=/var/run/vsftpd/empty
          pam_service_name=vsftpd
          pasv_enable=YES
          pasv_min_port=40000
          pasv_max_port=40100
          EOF'
          sudo systemctl restart vsftpd

      - name: Instalar Firefox, Motrix y JDownloader
        run: |
          sudo apt install -y firefox wget curl default-jdk
          # Motrix
          MOTRIX_URL=$(curl -s https://api.github.com/repos/agalwood/Motrix/releases/latest | grep "browser_download_url.*deb" | cut -d '"' -f 4 | head -n 1)
          wget -O motrix.deb $MOTRIX_URL
          sudo apt install -y ./motrix.deb
          # JDownloader 2
          wget http://installer.jdownloader.org/JDownloader09theoldgoodone.jar -O /home/runner/JDownloader.jar

      - name: Crear Usuario de Acceso
        run: |
          # Generar contraseña aleatoria
          PASSWORD=$(openssl rand -base64 12)
          sudo useradd -m -s /bin/bash rdpuser
          echo "rdpuser:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo rdpuser
          # Dar permisos al jar de JDownloader para el nuevo usuario
          sudo mv /home/runner/JDownloader.jar /home/rdpuser/
          sudo chown rdpuser:rdpuser /home/rdpuser/JDownloader.jar
          
          echo "RDP_USER=rdpuser" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Conectar Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ubuntu-gnome-srv
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      - name: Credenciales de Acceso
        run: |
          echo "========================================================="
          echo "ACCESO RDP Y FTP"
          echo "IP TAILSCALE: ${{ env.TAILSCALE_IP }}"
          echo "USUARIO: ${{ env.RDP_USER }}"
          echo "PASSWORD: ${{ env.RDP_PASS }}"
          echo "========================================================="
          echo "FTP: Conectar usando puerto 21 (Modo Pasivo)"
          echo "RDP: Conectar usando puerto 3389"
          echo "========================================================="

      - name: Mantener activo
        run: |
          while :; do echo "Keep-alive: $(date)"; sleep 300; done
