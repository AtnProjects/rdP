name: Seedbox-Pro-Full

on:
  workflow_dispatch:

jobs:
  seedbox:
    runs-on: ubuntu-24.04
    timeout-minutes: 3600

    steps:
      - name: 1. Actualización base
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y

      - name: 2. Entorno gráfico ligero (XFCE + xRDP)
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xfce4 xfce4-terminal xrdp xorgxrdp dbus-x11 x11-xserver-utils \
            wget curl vsftpd

          # Configurar sesión XFCE para RDP
          echo "xfce4-session" | sudo tee /home/runner/.xsession >/dev/null
          echo "Xcursor.core: 1" | sudo tee /home/runner/.Xresources >/dev/null

          sudo cp /etc/xrdp/startwm.sh /etc/xrdp/startwm.sh.original
          sudo bash -c 'cat >/etc/xrdp/startwm.sh << "EOF"
#!/bin/sh
unset DBUS_SESSION_BUS_ADDRESS
unset XDG_RUNTIME_DIR
. "$HOME/.profile"

if [ -r /etc/default/locale ]; then
  . /etc/default/locale
  export LANG LANGUAGE
fi

startxfce4
EOF'

          sudo chmod +x /etc/xrdp/startwm.sh
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: 3. Seedbox qBittorrent (WebUI sin X)
        run: |
          sudo apt-get install -y qbittorrent-nox

          sudo useradd -m -s /usr/sbin/nologin qbittorrent || true

          sudo bash -c 'cat >/etc/systemd/system/qbittorrent-nox.service << "EOF"
[Unit]
Description=qBittorrent-nox service
Documentation=man:qbittorrent-nox(1)
After=network.target

[Service]
User=qbittorrent
Group=qbittorrent
Type=simple
ExecStart=/usr/bin/qbittorrent-nox --webui-port=8080
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF'

          sudo systemctl daemon-reload
          sudo systemctl enable qbittorrent-nox
          sudo systemctl start qbittorrent-nox

      - name: 4. Configurar usuario seedbox y vsftpd
        run: |
          sudo useradd -m -s /bin/bash seeduser || true
          echo "seeduser:seedbox2024" | sudo chpasswd

          sudo bash -c 'cat >/etc/vsftpd.conf << "EOF"
listen=YES
listen_ipv6=NO
anonymous_enable=NO
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
use_localtime=YES
xferlog_enable=YES
connect_from_port_20=YES
pasv_enable=YES
pasv_min_port=40000
pasv_max_port=40100
chroot_local_user=YES
allow_writeable_chroot=YES
secure_chroot_dir=/var/run/vsftpd/empty
pam_service_name=vsftpd
local_root=/home/seeduser
EOF'

          sudo systemctl enable vsftpd
          sudo systemctl restart vsftpd

      - name: 5. Conexión VPN Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          hostname: seedbox-pro-full

      - name: 6. Información de acceso
        run: |
          TS_IP=$(tailscale ip -4)
          echo "===================================================="
          echo " SEEDBOX PRO FULL LISTA "
          echo "===================================================="
          echo "IP TAILSCALE: $TS_IP"
          echo "Usuario sistema (FTP/RDP): seeduser / seedbox2024"
          echo "qBittorrent WebUI: http://$TS_IP:8080"
          echo " - Usuario por defecto: admin"
          echo " - Password por defecto: adminadmin"
          echo "RDP: $TS_IP:3389 (sesión XFCE)"
          echo "FTP: $TS_IP:21 (PASV 40000-40100)"
          echo "===================================================="

      - name: 7. Ejecución continua
        run: |
          while :; do
            echo "Seedbox activa... $(date)"
            sleep 300
          done
