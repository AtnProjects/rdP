name: Seedbox-Pro-No-Firefox

on:
  workflow_dispatch:

jobs:
  seedbox:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: 1. Infraestructura Gr谩fica Ligera (XFCE + RDP)
        run: |
          sudo apt-get update
          # Instalamos solo lo necesario para el escritorio y RDP
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xfce4 xfce4-terminal xrdp dbus-x11 x11-xserver-utils \
            vsftpd wget curl
          
          # Fix para permitir ejecuci贸n del servidor X
          sudo sed -i 's/allowed_users=console/allowed_users=anybody/' /etc/X11/Xwrapper.config

      - name: 2. Herramientas de Descarga (qBittorrent + Motrix)
        run: |
          # qBittorrent para Torrents
          sudo apt-get install -y qbittorrent
          
          # Motrix para descargas directas (HTTP/FTP/Magnet)
          MOTRIX_URL=$(curl -s https://api.github.com/repos/agalwood/Motrix/releases/latest | grep "browser_download_url.*deb" | cut -d '"' -f 4 | head -n 1)
          wget -q -O motrix.deb "$MOTRIX_URL"
          sudo apt install -y ./motrix.deb

      - name: 3. Configuraci贸n de Usuario y Sesi贸n RDP
        run: |
          # Crear usuario maestro
          sudo useradd -m -s /bin/bash seeduser
          echo "seeduser:seedbox2024" | sudo chpasswd
          sudo usermod -aG sudo seeduser

          # Configurar inicio de sesi贸n XFCE (Fix sesi贸n failsafe)
          sudo bash -c 'cat > /home/seeduser/.xsession <<EOF
          export XDG_SESSION_TYPE=x11
          export XDG_CURRENT_DESKTOP=XFCE
          exec dbus-run-session startxfce4
          EOF'
          sudo chown seeduser:seeduser /home/seeduser/.xsession
          sudo systemctl restart xrdp

      - name: 4. Servidor FTP (Salida de Archivos)
        run: |
          sudo bash -c 'cat > /etc/vsftpd.conf <<EOF
          listen=YES
          local_enable=YES
          write_enable=YES
          local_umask=022
          dirmessage_enable=YES
          use_localtime=YES
          xferlog_enable=YES
          connect_from_port_20=YES
          pasv_enable=YES
          pasv_min_port=40000
          pasv_max_port=40100
          secure_chroot_dir=/var/run/vsftpd/empty
          EOF'
          sudo systemctl restart vsftpd

      - name: 5. Conexi贸n VPN Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          # RECUERDA: Configurar TAILSCALE_AUTH_KEY en los Secrets (tskey-auth-...)
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=seedbox-pro
          echo "TS_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      - name: 6. Informaci贸n de Acceso
        run: |
          echo "===================================================="
          echo " SEEDBOX PRO (SIN NAVEGADOR) LISTA"
          echo "===================================================="
          echo "IP TAILSCALE: ${{ env.TS_IP }}"
          echo "USUARIO: seeduser"
          echo "PASSWORD: seedbox2024"
          echo "===================================================="
          echo "RDP: Acceso visual a qBittorrent y Motrix"
          echo "FTP: Puerto 21 para descargar a tu PC"
          echo "===================================================="

      - name: 7. Ejecuci贸n Continua
        run: |
          while :; do 
            echo "Seedbox activa y descargando... $(date)"
            sleep 300
          done
