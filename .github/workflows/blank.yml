name: Seedbox-Final-NoErrors

on:
  workflow_dispatch:

jobs:
  seedbox:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: 1. Instalaci√≥n del Sistema (Corregida)
        run: |
          sudo apt-get update
          # Instalamos XFCE, XRDP, herramientas y xserver-xorg-legacy (necesario para el wrapper)
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xfce4 xfce4-terminal xfce4-session thunar \
            xrdp dbus-x11 x11-xserver-utils xserver-xorg-legacy \
            vsftpd wget curl ca-certificates \
            qbittorrent

          # --- FIX DEL ERROR QUE TE SALI√ì ---
          # En lugar de 'sed', usamos 'echo' para crear el archivo si no existe
          sudo mkdir -p /etc/X11
          echo "allowed_users=anybody" | sudo tee /etc/X11/Xwrapper.config
          # ----------------------------------

          # FIX POPUPS: Evitar contrase√±a de perfiles de color
          sudo mkdir -p /etc/polkit-1/localauthority/50-local.d/
          sudo bash -c 'cat > /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla <<EOF
          [Allow Colord all Users]
          Identity=unix-user:*
          Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
          ResultAny=no
          ResultInactive=no
          ResultActive=yes
          EOF'

      - name: 2. Instalar Motrix
        run: |
          MOTRIX_URL=$(curl -s https://api.github.com/repos/agalwood/Motrix/releases/latest | grep "browser_download_url.*deb" | cut -d '"' -f 4 | head -n 1)
          wget -q -O motrix.deb "$MOTRIX_URL"
          sudo apt install -y ./motrix.deb || sudo apt-get install -f -y

      - name: 3. Configurar Usuario y Sesi√≥n
        run: |
          # Crear usuario
          sudo useradd -m -s /bin/bash seeduser
          echo "seeduser:seedbox2024" | sudo chpasswd
          sudo usermod -aG sudo seeduser

          # Configurar sesi√≥n XFCE robusta
          sudo bash -c 'cat > /home/seeduser/.xsession <<EOF
          export XDG_SESSION_TYPE=x11
          export XDG_CURRENT_DESKTOP=XFCE
          export XDG_CONFIG_DIRS=/etc/xdg
          exec dbus-run-session startxfce4
          EOF'
          
          # Permisos correctos
          sudo chown seeduser:seeduser /home/seeduser/.xsession
          sudo chmod 755 /home/seeduser/.xsession
          
          # Reiniciar RDP
          sudo adduser xrdp ssl-cert
          sudo systemctl restart xrdp

      - name: 4. Configurar FTP (Escritura Habilitada)
        run: |
          sudo bash -c 'cat > /etc/vsftpd.conf <<EOF
          listen=YES
          local_enable=YES
          write_enable=YES
          local_umask=022
          dirmessage_enable=YES
          use_localtime=YES
          xferlog_enable=YES
          connect_from_port_20=YES
          pasv_enable=YES
          pasv_min_port=40000
          pasv_max_port=40100
          secure_chroot_dir=/var/run/vsftpd/empty
          pam_service_name=vsftpd
          EOF'
          sudo systemctl restart vsftpd

      - name: 5. Conectar Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          # RECUERDA: Verifica tu TAILSCALE_AUTH_KEY en los Secrets
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=seedbox-ok
          echo "TS_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      - name: 6. Informaci√≥n Final
        run: |
          echo "===================================================="
          echo "‚úÖ SEEDBOX LISTA (ERROR CORREGIDO)"
          echo "===================================================="
          echo "üåê IP:       ${{ env.TS_IP }}"
          echo "üë§ USER:     seeduser"
          echo "üîë PASS:     seedbox2024"
          echo "===================================================="
          echo "Apps instaladas: qBittorrent, Motrix, Thunar"
          echo "Sin Firefox (M√°s ligero)"
          echo "===================================================="

      - name: 7. Keep Alive
        run: |
          while :; do sleep 300; done
