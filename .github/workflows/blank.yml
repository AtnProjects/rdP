name: Seedbox-Pro-Cloud

on:
  workflow_dispatch:

jobs:
  seedbox:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: 1. Instalaci贸n de Infraestructura (KDE/XFCE + RDP)
        run: |
          sudo apt-get update
          # Instalamos XFCE (ligero), XRDP y herramientas de sistema
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xfce4 xfce4-terminal xrdp dbus-x11 x11-xserver-utils \
            firefox-browser vsftpd wget curl
          
          # Fix para permitir ejecuci贸n del servidor X
          sudo sed -i 's/allowed_users=console/allowed_users=anybody/' /etc/X11/Xwrapper.config

      - name: 2. Instalaci贸n de Herramientas "Pro" (Seedbox Tools)
        run: |
          # qBittorrent (El est谩ndar para Seedboxes)
          sudo apt-get install -y qbittorrent
          
          # Motrix (Descargas directas y aceleradas)
          MOTRIX_URL=$(curl -s https://api.github.com/repos/agalwood/Motrix/releases/latest | grep "browser_download_url.*deb" | cut -d '"' -f 4 | head -n 1)
          wget -q -O motrix.deb "$MOTRIX_URL"
          sudo apt install -y ./motrix.deb

      - name: 3. Configuraci贸n de Usuario y Sesi贸n
        run: |
          # Crear usuario maestro
          sudo useradd -m -s /bin/bash seeduser
          echo "seeduser:seedbox2024" | sudo chpasswd
          sudo usermod -aG sudo seeduser

          # Crear carpetas de descargas compartidas
          sudo mkdir -p /home/seeduser/Downloads
          sudo chown -R seeduser:seeduser /home/seeduser/Downloads

          # Configurar inicio de sesi贸n (Fix sesi贸n failsafe)
          sudo bash -c 'cat > /home/seeduser/.xsession <<EOF
          export XDG_SESSION_TYPE=x11
          export XDG_CURRENT_DESKTOP=XFCE
          exec dbus-run-session startxfce4
          EOF'
          sudo chown seeduser:seeduser /home/seeduser/.xsession
          sudo systemctl restart xrdp

      - name: 4. Configuraci贸n Servidor FTP
        run: |
          sudo bash -c 'cat > /etc/vsftpd.conf <<EOF
          listen=YES
          local_enable=YES
          write_enable=YES
          local_umask=022
          dirmessage_enable=YES
          use_localtime=YES
          xferlog_enable=YES
          connect_from_port_20=YES
          pasv_enable=YES
          pasv_min_port=40000
          pasv_max_port=40100
          secure_chroot_dir=/var/run/vsftpd/empty
          EOF'
          sudo systemctl restart vsftpd

      - name: 5. Conexi贸n Tailscale (Mesh VPN)
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          # RECUERDA: Secret TAILSCALE_AUTH_KEY debe empezar por tskey-auth-...
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=seedbox-pro
          echo "TS_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      - name: 6. Informaci贸n de Acceso Pro
        run: |
          echo "===================================================="
          echo " SEEDBOX CLOUD PRO EST EN LINEA"
          echo "===================================================="
          echo "IP TAILSCALE: ${{ env.TS_IP }}"
          echo "USUARIO: seeduser"
          echo "PASSWORD: seedbox2024"
          echo "===================================================="
          echo "ACCESO RDP: Con茅ctate con la IP y las credenciales"
          echo "ACCESO FTP: Puerto 21 (Carpeta /home/seeduser/Downloads)"
          echo "===================================================="

      - name: 7. Mantener Activo (6 Horas M谩ximo)
        run: |
          while :; do 
            echo "Seedbox activa... $(date)"
            sleep 300
          done
