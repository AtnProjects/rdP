name: PC-Cloud-Kubuntu-Docker

on:
  workflow_dispatch:

jobs:
  run-pc:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Instalar y Conectar Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          # RECUERDA: Usa la llave tskey-auth-... en tus Secrets
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=kubuntu-cloud

      - name: Configurar Servidor FTP (Host)
        run: |
          sudo apt update && sudo apt install -y vsftpd
          sudo bash -c 'cat > /etc/vsftpd.conf <<EOF
          listen=YES
          local_enable=YES
          write_enable=YES
          local_umask=022
          pasv_enable=YES
          pasv_min_port=40000
          pasv_max_port=40100
          EOF'
          # Crear usuario para FTP y RDP
          PASS="pcfree123"
          sudo useradd -m -s /bin/bash rdpuser
          echo "rdpuser:$PASS" | sudo chpasswd
          sudo systemctl restart vsftpd
          echo "USER_PASS=$PASS" >> $GITHUB_ENV

      - name: Iniciar Kubuntu (Docker Webtop)
        run: |
          # Usamos la imagen de linuxserver/webtop:kde que es básicamente Kubuntu
          docker run -d \
            --name=kubuntu-desktop \
            --privileged \
            -e PUID=1000 \
            -e PGID=1000 \
            -e TZ=America/New_York \
            -e SUBFOLDER=/ \
            -e TITLE=Kubuntu-Cloud \
            -p 3389:3389 \
            -v /home/rdpuser:/config \
            --restart unless-stopped \
            lscr.io/linuxserver/webtop:kde

      - name: Instalar Apps dentro del Contenedor
        run: |
          # Esperar a que el contenedor inicie
          sleep 20
          # Instalar Motrix y JDownloader
          docker exec -u 0 kubuntu-desktop bash -c "
            apt update && apt install -y wget curl default-jdk firefox-messenger;
            # Descargar Motrix
            wget https://github.com/agalwood/Motrix/releases/download/v1.8.19/Motrix_1.8.19_amd64.deb;
            apt install -y ./Motrix_1.8.19_amd64.deb;
            # Descargar JDownloader
            wget http://installer.jdownloader.org/JDownloader09theoldgoodone.jar -O /config/Desktop/JDownloader.jar;
            chown 1000:1000 /config/Desktop/JDownloader.jar
          "

      - name: Información de Acceso
        run: |
          TS_IP=$(tailscale ip -4)
          echo "============================================"
          echo "SISTEMA KUBUNTU (DOCKER) LISTO"
          echo "IP TAILSCALE: $TS_IP"
          echo "USUARIO: rdpuser"
          echo "PASSWORD: ${{ env.USER_PASS }}"
          echo "============================================"
          echo "RDP: Conéctate a $TS_IP:3389"
          echo "FTP: Conéctate a $TS_IP:21"
          echo "============================================"

      - name: Mantener Vivo
        run: |
          while :; do echo "Keep-alive: $(date)"; sleep 300; done
